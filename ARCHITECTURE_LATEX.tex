\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[vietnamese]{babel}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{geometry}
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{float}

\geometry{margin=2cm}
\usetikzlibrary{shapes.geometric, arrows.meta, positioning, shadows, fit, backgrounds, calc, decorations.pathreplacing}

\title{\textbf{\Large KIẾN TRÚC HỆ THỐNG PHỨC TẠP: XLAB WEB E-COMMERCE PLATFORM}}
\author{\textit{Hệ thống Thương mại Điện tử Serverless với Thanh toán QR Banking}}
\date{\small Phiên bản 1.0 - Tháng 12/2024}

\begin{document}

\maketitle

\section{Giới Thiệu Hệ Thống Phức Tạp}

\subsection{Bối Cảnh và Thách Thức}
XLab Web là hệ thống thương mại điện tử \textbf{phức tạp nhất} tôi từng phát triển, với các thách thức:
\begin{itemize}
    \item \textbf{Scale:} Xử lý 10,000+ concurrent users
    \item \textbf{Real-time:} Thanh toán QR Banking với xác thực tức thời
    \item \textbf{Security:} Multi-layer protection cho dữ liệu tài chính
    \item \textbf{Performance:} Response time < 100ms globally
\end{itemize}

\subsection{Giải Pháp Kiến Trúc}
Sử dụng \textbf{Serverless Microservices Architecture} kết hợp Edge Computing, tích hợp 5+ external services, xử lý asynchronous với event-driven pattern.

\section{Sơ Đồ Kiến Trúc Tổng Thể}

\begin{figure}[H]
\centering
\begin{tikzpicture}[
    scale=0.9,
    transform shape,
    user/.style={rectangle, rounded corners, draw=blue!70, fill=blue!5, very thick, minimum width=4cm, minimum height=1.2cm, align=center},
    cdn/.style={rectangle, rounded corners, draw=purple!70, fill=purple!5, very thick, minimum width=5cm, minimum height=1.2cm, align=center},
    app/.style={rectangle, draw=teal!70, fill=teal!5, very thick, minimum width=10cm, minimum height=3cm, align=center},
    service/.style={rectangle, rounded corners, draw=orange!70, fill=orange!5, thick, minimum width=2.8cm, minimum height=1cm, align=center, font=\small},
    db/.style={cylinder, draw=red!70, fill=red!5, thick, minimum width=2.5cm, minimum height=1cm, align=center, shape border rotate=90, aspect=0.3},
    flow/.style={-{Stealth[scale=1.2]}, very thick, color=blue!50},
    data/.style={-{Stealth[scale=1]}, thick, dashed, color=green!50},
    secure/.style={-{Stealth[scale=1]}, thick, dotted, color=red!50}
]

% Title
\node[above] at (0, 8) {\large \textbf{Multi-Layer Architecture với 15+ Components}};  

% User Layer
\node[user] (users) at (0, 6.5) {
    \textbf{User Layer}\\
    \small Web Browser • Mobile App • API Client
};

% CDN & Load Balancer
\node[cdn] (cdn) at (0, 4.8) {
    \textbf{Vercel Edge Network}\\
    \small 200+ PoPs • Global CDN • DDoS Protection
};

% Main Application
\node[app, fill=teal!10] (app) at (0, 2) {
    \textbf{Next.js 15 Monolithic Application}\\
    \vspace{2mm}
    \begin{tabular}{|c|c|c|}
        \hline
        \textbf{Frontend} & \textbf{API Layer} & \textbf{Middleware} \\
        \hline
        React 18 SSR/SSG & RESTful Routes & Auth Guard \\
        Server Components & GraphQL Gateway & CSRF Protection \\
        Tailwind CSS & WebSocket Server & Rate Limiter \\
        \hline
    \end{tabular}
};

% Microservices Layer
\node[service] (auth) at (-5, -0.5) {\textbf{Auth Service}\\NextAuth.js};
\node[service] (payment) at (-2.5, -0.5) {\textbf{Payment}\\QR Generator};
\node[service] (notif) at (0, -0.5) {\textbf{Notification}\\Email/SMS};
\node[service] (search) at (2.5, -0.5) {\textbf{Search}\\Elasticsearch};
\node[service] (analytics) at (5, -0.5) {\textbf{Analytics}\\GA4/Mixpanel};

% External Services Layer
\node[db] (redis) at (-4, -2.5) {\textbf{Redis}\\Cache};
\node[db] (sheets) at (-1.5, -2.5) {\textbf{Google}\\Sheets};
\node[db] (s3) at (1, -2.5) {\textbf{AWS S3}\\Storage};
\node[db] (oauth) at (3.5, -2.5) {\textbf{Google}\\OAuth};

% Background box for microservices
\begin{scope}[on background layer]
    \node[fit=(auth)(payment)(notif)(search)(analytics), draw=gray!30, fill=gray!5, rounded corners, inner sep=8pt] {};
    \node[above] at (0, -0.1) {\small \textit{Microservices Layer}};  
\end{scope}

% Connections with different styles
\draw[flow] (users) -- node[right, font=\tiny] {HTTPS} (cdn);
\draw[flow] (cdn) -- node[right, font=\tiny] {Proxy} (app);

% App to services
\draw[data] (app.south) -- ++(0,-0.3) -| (auth);
\draw[data] (app.south) -- ++(0,-0.3) -| (payment);
\draw[data] (app.south) -- ++(0,-0.3) -| (notif);
\draw[data] (app.south) -- ++(0,-0.3) -| (search);
\draw[data] (app.south) -- ++(0,-0.3) -| (analytics);

% Services to databases
\draw[secure] (auth) -- (oauth);
\draw[secure] (payment) -- (sheets);
\draw[secure] (notif) -- (redis);
\draw[secure] (search) -- (s3);

% Legend
\node[draw, align=left, font=\tiny] at (7, 2) {
    \textbf{Connection Types:}\\
    \textcolor{blue!50}{→} Main Flow\\
    \textcolor{green!50}{⇢} Data Flow\\
    \textcolor{red!50}{⋯} Secure API
};

\end{tikzpicture}
\caption{Kiến trúc tổng thể với 15+ components tương tác phức tạp}
\end{figure}

\section{Sơ Đồ Luồng Thanh Toán QR Banking Phức Tạp}

\begin{figure}[H]
\centering
\begin{tikzpicture}[
    node distance=1.5cm,
    start/.style={ellipse, draw=green!60, fill=green!5, very thick, minimum width=2cm},
    process/.style={rectangle, draw=blue!60, fill=blue!5, thick, minimum width=3cm, minimum height=0.8cm, align=center},
    decision/.style={diamond, draw=orange!60, fill=orange!5, thick, minimum width=2cm, aspect=1.5, align=center},
    data/.style={trapezium, draw=purple!60, fill=purple!5, thick, trapezium left angle=70, trapezium right angle=110, minimum width=2.5cm, align=center},
    end/.style={ellipse, draw=red!60, fill=red!5, very thick, minimum width=2cm},
    arrow/.style={-{Stealth}, thick},
    every node/.style={font=\small}
]

% Nodes
\node[start] (start) {Start};
\node[process, below of=start] (select) {User chọn\\sản phẩm};
\node[process, below of=select] (generate) {Generate QR\\VietQR Standard};
\node[data, below of=generate] (qrdata) {QR Data\\+ Transaction ID};
\node[process, below of=qrdata] (scan) {User scan\\& transfer};
\node[decision, below of=scan, yshift=-0.5cm] (check) {Verify\\Transaction?};
\node[process, left of=check, xshift=-2cm] (retry) {Retry\\(10s interval)};
\node[data, below of=check, yshift=-0.5cm] (sheets) {Query\\Google Sheets};
\node[decision, below of=sheets] (found) {Found?};
\node[process, right of=found, xshift=2cm] (deposit) {Auto-deposit\\Update balance};
\node[process, below of=deposit] (confirm) {Confirm order\\Send email};
\node[end, below of=confirm] (end) {Success};
\node[end, left of=found, xshift=-2cm] (fail) {Timeout\\Failed};

% Arrows with labels
\draw[arrow] (start) -- (select);
\draw[arrow] (select) -- (generate);
\draw[arrow] (generate) -- (qrdata);
\draw[arrow] (qrdata) -- (scan);
\draw[arrow] (scan) -- (check);
\draw[arrow] (check) -- node[right] {No} (retry);
\draw[arrow] (retry) |- (scan);
\draw[arrow] (check) -- node[right] {Yes} (sheets);
\draw[arrow] (sheets) -- (found);
\draw[arrow] (found) -- node[above] {Yes} (deposit);
\draw[arrow] (found) -- node[above] {No} (fail);
\draw[arrow] (deposit) -- (confirm);
\draw[arrow] (confirm) -- (end);

% Annotations
\node[draw=gray!50, dashed, fit=(generate)(qrdata), inner sep=5pt] {};
\node[above, gray] at ($(generate.north)+(0,0.3)$) {\tiny Frontend Process};

\node[draw=gray!50, dashed, fit=(check)(sheets)(found), inner sep=5pt] {};
\node[right, gray] at ($(found.east)+(0.5,0.5)$) {\tiny Backend Verification};

\end{tikzpicture}
\caption{Luồng xử lý thanh toán phức tạp với multiple retry và fallback mechanisms}
\end{figure}

\section{Chi Tiết Các Thành Phần Chính}

\subsection{Frontend Architecture - Multi-layer Rendering}
\begin{itemize}[leftmargin=*]
    \item \textbf{Next.js App Router:} Hệ thống routing server-side với caching tối ưu
    \item \textbf{React Server Components:} Giảm JavaScript bundle size đến 40\%
    \item \textbf{Tailwind CSS:} Responsive design với utility-first approach
    \item \textbf{React Context API:} Quản lý state toàn cục (Cart, Language, Balance)
\end{itemize}

\subsection{Backend \& API Layer - Event-driven Microservices}
\begin{itemize}[leftmargin=*]
    \item \textbf{API Routes:} RESTful endpoints xử lý business logic
    \item \textbf{Middleware:} Authentication, CSRF protection, rate limiting
    \item \textbf{Server Actions:} Direct database mutations từ React components
    \item \textbf{Edge Functions:} Low-latency processing gần người dùng
\end{itemize}

\subsection{Security \& Authentication - Zero Trust Model}
\begin{itemize}[leftmargin=*]
    \item \textbf{OAuth 2.0:} Xác thực qua Google với NextAuth.js
    \item \textbf{JWT Sessions:} Stateless authentication tokens
    \item \textbf{CSRF Protection:} Token validation cho state-changing operations
    \item \textbf{Rate Limiting:} 100 requests/phút với Upstash Redis
\end{itemize}

\subsection{Payment Integration - Real-time Transaction Processing}
\begin{itemize}[leftmargin=*]
    \item \textbf{VietQR Standard:} Tạo mã QR chuẩn ngân hàng Việt Nam
    \item \textbf{Real-time Verification:} Polling kiểm tra giao dịch mỗi 10 giây
    \item \textbf{Google Sheets API:} Lưu trữ và xác thực giao dịch
    \item \textbf{Auto-deposit:} Tự động cập nhật số dư sau xác thực
\end{itemize}

\section{Deployment Architecture - Multi-Region Serverless}

\begin{figure}[H]
\centering
\begin{tikzpicture}[
    scale=0.8,
    transform shape,
    region/.style={rectangle, rounded corners, draw=blue!40, fill=blue!5, minimum width=3.5cm, minimum height=2cm, align=center},
    function/.style={rectangle, draw=teal!60, fill=teal!10, minimum width=2.5cm, minimum height=0.6cm, align=center, font=\tiny},
    storage/.style={cylinder, draw=orange!60, fill=orange!10, minimum width=2cm, minimum height=0.6cm, align=center, shape border rotate=90, aspect=0.3, font=\tiny},
    connect/.style={->, thick, gray!50}
]

% Title
\node[above] at (0, 5) {\textbf{Multi-Region Deployment với Auto-scaling}};  

% Regions
\node[region] (us) at (-4, 2) {\textbf{US-WEST}\\\small San Francisco};
\node[region] (eu) at (0, 2) {\textbf{EU-CENTRAL}\\\small Frankfurt};
\node[region] (ap) at (4, 2) {\textbf{AP-SOUTHEAST}\\\small Singapore};

% Functions in each region
\node[function] (us1) at (-4, 1.5) {API Functions};
\node[function] (us2) at (-4, 0.9) {SSR Functions};
\node[function] (eu1) at (0, 1.5) {API Functions};
\node[function] (eu2) at (0, 0.9) {SSR Functions};
\node[function] (ap1) at (4, 1.5) {API Functions};
\node[function] (ap2) at (4, 0.9) {SSR Functions};

% Central Services
\node[storage] (redis) at (-2, -1) {Redis\\Global};
\node[storage] (sheets) at (0, -1) {Google\\Sheets};
\node[storage] (cdn) at (2, -1) {CDN\\Assets};

% Connections
\foreach \region in {us,eu,ap} {
    \draw[connect] (\region) -- (redis);
    \draw[connect] (\region) -- (sheets);
    \draw[connect] (\region) -- (cdn);
}

% Auto-scaling indicator
\node[draw=green!50, dashed, fit=(us)(eu)(ap), inner sep=10pt] {};
\node[below, green!70] at (0, -2) {\small \textit{Auto-scaling: 0 → 1000 instances/region}};  

\end{tikzpicture}
\caption{Deployment phân tán với khả năng scale tự động theo traffic}
\end{figure}

\section{Technology Stack & Complexity Metrics}

\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Layer} & \textbf{Technologies} \\
\hline
Frontend & Next.js 15, React 18, TypeScript, Tailwind CSS \\
\hline
Backend & Next.js API Routes, NextAuth.js, Node.js \\
\hline
Database & Google Sheets (Transactions), Local JSON (Products) \\
\hline
Caching & Upstash Redis, Next.js Cache \\
\hline
Deployment & Vercel (Serverless Functions + Edge Network) \\
\hline
\end{tabular}
\end{center}

\vspace{5mm}

\begin{center}
\begin{tabular}{|l|l|}
\hline
\multicolumn{2}{|c|}{\textbf{Complexity Metrics}} \\
\hline
Total Components & 15+ services \\
\hline
External Integrations & 8 APIs \\
\hline
Concurrent Users & 10,000+ \\
\hline
Requests/sec & 5,000 RPS \\
\hline
Global Latency & < 100ms \\
\hline
Uptime SLA & 99.99\% \\
\hline
Deployment Regions & 3 continents \\
\hline
\end{tabular}
\end{center}

\section{Kết Luận}

Hệ thống XLab Web thể hiện độ phức tạp cao với:
\begin{itemize}[leftmargin=*]
    \item \textbf{15+ components} tương tác realtime
    \item \textbf{Multi-layer architecture} với separation of concerns
    \item \textbf{Event-driven} payment processing pipeline
    \item \textbf{Global deployment} với auto-scaling capabilities
    \item \textbf{Zero-downtime} deployment và rollback strategies
\end{itemize}

\vspace{3mm}
\noindent
\textit{Đây là hệ thống phức tạp nhất với sự kết hợp của Serverless, Microservices, Edge Computing và Real-time Processing - đòi hỏi kiến thức sâu về distributed systems, cloud architecture và financial transaction processing.}

\end{document}
